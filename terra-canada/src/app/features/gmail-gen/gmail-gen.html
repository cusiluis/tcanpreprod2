<div class="gmail-gen-layout">
  <!-- Sidebar -->
  <app-sidebar></app-sidebar>

  <!-- Main Content -->
  <main class="gmail-gen-content">
    <!-- Toasts de confirmación -->
    <div class="toast-notification" *ngIf="showSuccessToast">
      <div class="toast-content">
        <i class="pi pi-check-circle"></i>
        <div class="toast-text">
          <h4>¡Éxito!</h4>
          <p>{{ successToastMessage }}</p>
        </div>
      </div>
    </div>

    <div class="toast-notification toast-error" *ngIf="showErrorToast">
      <div class="toast-content">
        <i class="pi pi-exclamation-triangle"></i>
        <div class="toast-text">
          <h4>Error</h4>
          <p>{{ errorToastMessage }}</p>
        </div>
      </div>
    </div>
    <!-- Top Header -->
    <app-top-header></app-top-header>

    <!-- Page Header -->
    <div class="page-header">
      <div class="header-left">
        <h1>{{ 'gmailGen' | translate }}</h1>
        <p class="header-subtitle">{{ 'gmailGenDescripcion' | translate }}</p>
      </div>
    </div>

    <!-- Content Container -->
    <div class="content-container">
      <!-- Tabs Todos / Pasados -->
      <div class="filters-row">
        <div class="filters-spacer"></div>
        <div class="date-toggle">
          <button
            type="button"
            class="toggle-btn"
            [class.active]="filter === 'todos'"
            (click)="setFilter('todos')"
          >
            <i class="pi pi-inbox"></i>
            <span>Todos</span>
          </button>
          <button
            type="button"
            class="toggle-btn"
            [class.active]="filter === 'pasados'"
            (click)="setFilter('pasados')"
          >
            <i class="pi pi-history"></i>
            <span>Pasados</span>
          </button>
        </div>
      </div>

      <!-- Sección TODOS: correos pendientes (hoy y otros días) + enviados hoy -->
      <ng-container *ngIf="filter === 'todos'">
        <div class="section-title">
          <h2>Correos pendientes de envío</h2>
        </div>

        <div class="cards-grid" *ngIf="filteredGroups.length > 0">
          <div
            class="provider-card provider-card--teal"
            *ngFor="let group of filteredGroups"
          >
            <div class="card-header">
              <h3>{{ group.proveedorNombre }}</h3>
              <button type="button" class="card-menu-btn">
                <i class="pi pi-ellipsis-v"></i>
              </button>
            </div>

            <div class="payments-list">
              <div class="payment-item" *ngFor="let pago of group.pagos">
                <div class="payment-labels">
                  <div class="label-row">
                    <span class="label">Cliente</span>
                    <span class="value strong">{{ pago.cliente }}</span>
                  </div>
                  <div class="label-row">
                    <span class="label">Monto Pagado</span>
                    <span class="value amount">
                      {{ pago.monto | currency:'USD':'symbol':'1.2-2' }}
                    </span>
                  </div>
                  <div class="label-row">
                    <span class="label">Código Referencia</span>
                    <span class="value code">{{ pago.codigo }}</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="card-footer">
              <div class="footer-left">
                <span class="footer-count">{{ group.totalPagos }} pagos</span>
                <span class="footer-total">
                  $ {{ group.totalMonto | number:'1.2-2' }}
                </span>
              </div>

              <div class="footer-right">
                <button
                  type="button"
                  class="btn-send-email"
                  (click)="openComposeModal(group)"
                >
                  <i class="pi pi-send"></i>
                  <span>Enviar Gmail</span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="history-empty" *ngIf="filteredGroups.length === 0">
          <i class="pi pi-inbox"></i>
          <span>No hay correos pendientes de envío.</span>
        </div>

        <!-- Tarjetas de correos ENVIADOS HOY (gris, solo ver detalles) -->
        <div class="section-title section-title--sub" *ngIf="sentGroupsToday.length > 0">
          <h3>Correos enviados hoy</h3>
        </div>

        <div class="cards-grid" *ngIf="sentGroupsToday.length > 0">
          <div
            class="provider-card provider-card--sent"
            *ngFor="let group of sentGroupsToday"
          >
            <div class="card-header">
              <h3>{{ group.proveedorNombre }}</h3>
            </div>

            <div class="payments-list">
              <div class="payment-item" *ngFor="let pago of group.pagos">
                <div class="payment-labels">
                  <div class="label-row">
                    <span class="label">Cliente</span>
                    <span class="value strong">{{ pago.cliente }}</span>
                  </div>
                  <div class="label-row">
                    <span class="label">Monto Pagado</span>
                    <span class="value amount">
                      {{ pago.monto | currency:'USD':'symbol':'1.2-2' }}
                    </span>
                  </div>
                  <div class="label-row">
                    <span class="label">Código Referencia</span>
                    <span class="value code">{{ pago.codigo }}</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="card-footer card-footer--sent">
              <div class="footer-left">
                <span class="footer-count">{{ group.totalPagos }} pagos</span>
                <span class="footer-total">
                  $ {{ group.totalMonto | number:'1.2-2' }}
                </span>
              </div>

              <div class="footer-right footer-right--sent">
                <button
                  type="button"
                  class="btn-link"
                  (click)="openEnvioFromSummary(group)"
                >
                  Ver detalles
                </button>
              </div>
            </div>
          </div>
        </div>
      </ng-container>

      <!-- Sección PASADOS: historial de envíos de días anteriores (tarjetas grises) -->
      <ng-container *ngIf="filter === 'pasados'">
        <div class="section-title">
          <h2>Historial de correos enviados (pasados)</h2>
        </div>

        <div class="cards-grid" *ngIf="enviosPasados.length > 0">
          <div
            class="provider-card provider-card--sent"
            *ngFor="let envio of enviosPasados"
          >
            <div class="card-header">
              <h3>{{ envio.proveedor.nombre }}</h3>
            </div>

            <div class="payments-list">
              <div class="payment-item">
                <div class="payment-labels">
                  <div class="label-row">
                    <span class="label">Asunto</span>
                    <span class="value strong">{{ envio.asunto }}</span>
                  </div>
                  <div class="label-row">
                    <span class="label">Cantidad de pagos</span>
                    <span class="value amount">{{ envio.cantidad_pagos }}</span>
                  </div>
                  <div class="label-row">
                    <span class="label">Monto total</span>
                    <span class="value amount">
                      {{ envio.monto_total | currency:'USD':'symbol':'1.2-2' }}
                    </span>
                  </div>
                </div>
              </div>
            </div>

            <div class="card-footer card-footer--sent">
              <div class="footer-left">
                <span class="footer-count">
                  Resumen: {{ envio.fecha_resumen | date:'shortDate' }}
                </span>
                <span class="footer-total">
                  Enviado: {{ envio.fecha_envio | date:'short' }}
                </span>
              </div>

              <div class="footer-right footer-right--sent">
                <span class="sent-label">{{ envio.estado }}</span>
                <button
                  type="button"
                  class="btn-link"
                  (click)="openEnvioHistorialInfo(envio)"
                >
                  Ver detalles
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="history-empty" *ngIf="enviosPasados.length === 0">
          <i class="pi pi-inbox"></i>
          <span>No hay envíos registrados todavía.</span>
        </div>
      </ng-container>
    </div>

    <!-- Modal Redactar Correo -->
    <div class="modal-overlay" *ngIf="showComposeModal">
      <div class="modal-content modal-compose" (click)="$event.stopPropagation()">
        <button class="btn-close-modal" type="button" (click)="closeComposeModal()">
          <i class="pi pi-times"></i>
        </button>

        <div class="modal-header">
          <i class="pi pi-envelope modal-header-icon"></i>
          <h2>Redactar Correo de Confirmación</h2>
        </div>

        <div class="modal-body">
          <form (ngSubmit)="onSendEmail()" #composeFormRef="ngForm">
            <div class="form-group">
              <label>Para:</label>
              <input
                type="text"
                name="para"
                [value]="composeForm.para"
                readonly
                aria-readonly="true"
                tabindex="-1"
                class="static-input"
              />
            </div>

            <div class="form-group">
              <label>Asunto:</label>
              <input
                type="text"
                name="asunto"
                [(ngModel)]="composeForm.asunto"
                required
              />
            </div>

            <div class="form-group">
              <label>Mensaje:</label>
              <textarea
                name="mensaje"
                rows="4"
                [(ngModel)]="composeForm.mensaje"
              ></textarea>
            </div>

            <div class="payments-summary">
              <div class="summary-header">
                <i class="pi pi-list"></i>
                <span>Registros de Pago</span>
              </div>
              <div class="summary-list" *ngIf="selectedGroup">
                <div class="summary-item" *ngFor="let pago of selectedGroup.pagos">
                  <div class="summary-client">{{ pago.cliente }}</div>
                  <div class="summary-code"># {{ pago.codigo }}</div>
                  <div class="summary-amount">
                    {{ pago.monto | currency:'USD':'symbol':'1.2-2' }}
                  </div>
                </div>
              </div>
            </div>

            <div class="modal-actions">
              <button
                type="button"
                class="btn-secondary"
                (click)="closeComposeModal()"
              >
                Cancelar
              </button>
              <button
                type="submit"
                class="btn-primary"
                [disabled]="composeFormRef.invalid"
              >
                <i class="pi pi-send"></i>
                <span>Enviar Correo</span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal Información del Correo Enviado -->
    <div class="modal-overlay" *ngIf="showDetailsModal" (click)="closeDetailsModal()">
      <div class="modal-content modal-info" (click)="$event.stopPropagation()">
        <button class="btn-close-modal" type="button" (click)="closeDetailsModal()">
          <i class="pi pi-times"></i>
        </button>

        <div class="modal-header">
          <i class="pi pi-info-circle modal-header-icon"></i>
          <h2>Información del Correo Enviado</h2>
        </div>

        <div class="modal-body" *ngIf="selectedEmailInfo">
          <div class="info-row">
            <span class="info-label">Proveedor</span>
            <span class="info-value">{{ selectedEmailInfo.proveedorNombre }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Correo electrónico</span>
            <span class="info-value">{{ selectedEmailInfo.correoElectronico }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Asunto</span>
            <span class="info-value">{{ selectedEmailInfo.asunto }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Mensaje</span>
            <span class="info-value">{{ selectedEmailInfo.mensaje }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Registros enviados</span>
            <span class="info-value">
              {{ selectedEmailInfo.totalPagos }} pago(s) por un total de $
              {{ selectedEmailInfo.totalMonto | number:'1.2-2' }}
            </span>
          </div>
          <div
            class="payments-summary"
            *ngIf="selectedEmailInfo.pagosDetallados?.length"
          >
            <div class="summary-header">
              <i class="pi pi-list"></i>
              <span>Detalle de pagos enviados</span>
            </div>
            <div class="summary-list">
              <div
                class="summary-item"
                *ngFor="let pago of selectedEmailInfo.pagosDetallados"
              >
                <div class="summary-client">{{ pago.cliente }}</div>
                <div class="summary-code">
                  # {{ pago.codigo }}
                  <span class="summary-code-extra" *ngIf="pago.tipo_pago">
                    ({{ pago.tipo_pago }})
                  </span>
                </div>
                <div class="summary-amount">
                  {{ pago.monto | currency:'USD':'symbol':'1.2-2' }}
                </div>
                <div class="summary-extra" *ngIf="pago.medio_pago">
                  <span *ngIf="pago.tipo_pago === 'TARJETA'">
                    {{ pago.medio_pago?.tipo_tarjeta }}
                    &bull;
                    {{ pago.medio_pago?.numero }}
                  </span>
                  <span *ngIf="pago.tipo_pago === 'BANCARIO'">
                    {{ pago.medio_pago?.cuenta }}
                    <span *ngIf="pago.medio_pago?.moneda">
                      ({{ pago.medio_pago?.moneda }})
                    </span>
                  </span>
                </div>
                <div class="summary-date" *ngIf="pago.fecha_creacion">
                  {{ pago.fecha_creacion | date:'short' }}
                </div>
              </div>
            </div>
          </div>
          <div class="info-row">
            <span class="info-label">Fecha y hora de envío</span>
            <span class="info-value">{{ selectedEmailInfo.fechaEnvioTexto }}</span>
          </div>

          <div class="modal-actions single">
            <button type="button" class="btn-primary" (click)="closeDetailsModal()">
              Cerrar
            </button>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>
