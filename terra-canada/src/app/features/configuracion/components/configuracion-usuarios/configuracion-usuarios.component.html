<div class="usuarios-section">
  <div class="section-header">
    <div>
      <h3>
        <i class="pi pi-users"></i>
        {{ 'gestionUsuariosTitulo' | translate }}
      </h3>
      <p class="section-subtitle">
        {{ 'gestionUsuariosSubtitulo' | translate }}
      </p>
    </div>
    <button *ngIf="canManageUsers" type="button" class="btn-primary" (click)="abrirModalCrear()">
      <i class="pi pi-user-plus"></i>
      <span>{{ 'nuevoUsuario' | translate }}</span>
    </button>
  </div>

  <div class="search-container">
    <div class="search-input-wrapper">
      <i class="pi pi-search"></i>
      <input
        type="text"
        placeholder="{{ 'buscarUsuariosPlaceholder' | translate }}"
        [(ngModel)]="searchTerm"
        (input)="onSearch()"
        class="search-input"
      />
      <button *ngIf="searchTerm" (click)="clearSearch()" class="btn-clear">
        <i class="pi pi-times"></i>
      </button>
    </div>
  </div>

  <div class="table-container" *ngIf="!isLoading">
    <div class="table-wrapper">
      <table class="usuarios-table">
        <thead>
          <tr>
            <th>{{ 'usuario' | translate }}</th>
            <th>{{ 'nombreCompleto' | translate }}</th>
            <th>{{ 'correoLabel' | translate }}</th>
            <th>{{ 'telefono' | translate }}</th>
            <th>{{ 'rolLabel' | translate }}</th>
            <th *ngIf="canManageUsers">{{ 'acciones' | translate }}</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let u of filteredUsuarios" class="usuario-row">
            <td>{{ u.nombre_usuario }}</td>
            <td>{{ u.nombre_completo }}</td>
            <td>{{ u.correo }}</td>
            <td>{{ u.telefono || '-' }}</td>
            <td>{{ u.rolNombre || '-' }}</td>
            <td *ngIf="canManageUsers" class="cell-actions">
              <div class="action-buttons">
                <button
                  type="button"
                  class="action-btn edit-btn"
                  title="Editar usuario"
                  (click)="abrirModalEditar(u)"
                >
                  <i class="pi pi-pencil"></i>
                </button>
                <button
                  type="button"
                  class="action-btn password-btn"
                  title="Cambiar contraseña"
                  (click)="onCambiarContrasena(u)"
                >
                  <i class="pi pi-key"></i>
                </button>
                <button
                  type="button"
                  class="action-btn deactivate-btn"
                  title="Eliminar usuario"
                  (click)="abrirModalEliminar(u)"
                >
                  <i class="pi pi-trash"></i>
                </button>
              </div>
            </td>
          </tr>
          <tr *ngIf="filteredUsuarios.length === 0">
            <td [attr.colspan]="canManageUsers ? 6 : 5" class="empty-message">{{ 'usuariosVacio' | translate }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="loading" *ngIf="isLoading">
    <i class="pi pi-spin pi-spinner"></i>
    <span>{{ 'cargandoUsuarios' | translate }}</span>
  </div>

  <div class="error-message" *ngIf="errorMessage">
    <i class="pi pi-exclamation-triangle"></i>
    <span>{{ errorMessage }}</span>
  </div>

  <!-- Modal: Crear Usuario -->
  <div class="modal-overlay" *ngIf="showCreateModal">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <button type="button" class="btn-close-modal" (click)="cerrarModalCrear()">
        <i class="pi pi-times"></i>
      </button>
      <h2>{{ 'modalNuevoUsuarioTitulo' | translate }}</h2>

      <div class="modal-body">
        <div class="form-group">
          <label>{{ 'usuario' | translate }} *</label>
          <input type="text" [(ngModel)]="nuevoUsuario.nombre_usuario" class="form-input" />
        </div>

        <div class="form-group">
          <label>{{ 'correoLabel' | translate }} *</label>
          <input type="email" [(ngModel)]="nuevoUsuario.correo" class="form-input" />
        </div>

        <div class="form-group">
          <label>{{ 'nombreCompleto' | translate }} *</label>
          <input type="text" [(ngModel)]="nuevoUsuario.nombre_completo" class="form-input" />
        </div>

        <div class="form-group">
          <label>{{ 'telefono' | translate }}</label>
          <input
            type="text"
            [(ngModel)]="nuevoUsuario.telefono"
            class="form-input"
            inputmode="numeric"
            (input)="onTelefonoInputNuevo($event)"
          />
        </div>

        <div class="form-group">
          <label>{{ 'rolLabel' | translate }} *</label>
          <select [(ngModel)]="nuevoUsuario.rol_id" class="form-input">
            <option *ngFor="let rol of roles" [ngValue]="rol.id">{{ rol.nombre }}</option>
          </select>
        </div>

        <div class="form-group">
          <label>{{ 'cambiarContrasena' | translate }} *</label>
          <div class="password-input-wrapper">
            <input
              [type]="showPassword ? 'text' : 'password'"
              [(ngModel)]="nuevoUsuario.contrasena"
              class="form-input"
            />
            <button
              type="button"
              class="btn-toggle-password"
              (click)="togglePasswordVisibility()"
            >
              <i class="pi" [ngClass]="showPassword ? 'pi-eye-slash' : 'pi-eye'"></i>
            </button>
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn-cancel" (click)="cerrarModalCrear()">
          <i class="pi pi-times"></i>
          {{ 'cancelar' | translate }}
        </button>
        <button type="button" class="btn-primary" (click)="onCrearUsuario()">
          <i class="pi pi-check"></i>
          {{ 'crearUsuarioAccion' | translate }}
        </button>
      </div>
    </div>
  </div>

  <!-- Modal: Editar Usuario -->
  <div class="modal-overlay" *ngIf="showEditModal">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <button type="button" class="btn-close-modal" (click)="cerrarModalEditar()">
        <i class="pi pi-times"></i>
      </button>
      <h2>{{ 'modalEditarUsuarioTitulo' | translate }}</h2>

      <div class="modal-body">
        <div class="form-group">
          <label>{{ 'usuario' | translate }}</label>
          <input type="text" [(ngModel)]="editarUsuarioForm.nombre_usuario" class="form-input" />
        </div>

        <div class="form-group">
          <label>{{ 'correoLabel' | translate }}</label>
          <input type="email" [(ngModel)]="editarUsuarioForm.correo" class="form-input" />
        </div>

        <div class="form-group">
          <label>{{ 'nombreCompleto' | translate }}</label>
          <input type="text" [(ngModel)]="editarUsuarioForm.nombre_completo" class="form-input" />
        </div>

        <div class="form-group">
          <label>{{ 'telefono' | translate }}</label>
          <input
            type="text"
            [(ngModel)]="editarUsuarioForm.telefono"
            class="form-input"
            inputmode="numeric"
            (input)="onTelefonoInputEditar($event)"
          />
        </div>

        <div class="form-group">
          <label>{{ 'rolLabel' | translate }}</label>
          <select [(ngModel)]="editarUsuarioForm.rol_id" class="form-input">
            <option *ngFor="let rol of roles" [ngValue]="rol.id">{{ rol.nombre }}</option>
          </select>
        </div>

        <div class="form-group">
          <label>{{ 'estadoLabel' | translate }}</label>
          <select [(ngModel)]="editarUsuarioForm.esta_activo" class="form-input">
            <option [ngValue]="true">{{ 'activo' | translate }}</option>
            <option [ngValue]="false">{{ 'inactivo' | translate }}</option>
          </select>
        </div>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn-cancel" (click)="cerrarModalEditar()">
          <i class="pi pi-times"></i>
          {{ 'cancelar' | translate }}
        </button>
        <button type="button" class="btn-primary" (click)="onEditarUsuario()">
          <i class="pi pi-check"></i>
          {{ 'guardarCambios' | translate }}
        </button>
      </div>
    </div>
  </div>

  <!-- Modal: Confirmar eliminación (desactivación) -->
  <div class="modal-overlay" *ngIf="showDeleteConfirm">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <button type="button" class="btn-close-modal" (click)="cerrarModalEliminar()">
        <i class="pi pi-times"></i>
      </button>
      <h2>{{ 'modalEliminarUsuarioTitulo' | translate }}</h2>
      <div class="modal-body">
        <p>
          {{ 'eliminarUsuarioPregunta' | translate }}
          <strong>{{ usuarioAEliminar?.nombre_usuario }}</strong>?
        </p>
        <p>
          {{ 'eliminarUsuarioNota' | translate }}
        </p>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn-cancel" (click)="cerrarModalEliminar()">
          <i class="pi pi-times"></i>
          {{ 'cancelar' | translate }}
        </button>
        <button type="button" class="btn-primary" (click)="confirmarEliminarUsuario()">
          <i class="pi pi-trash"></i>
          {{ 'eliminarUsuarioAccion' | translate }}
        </button>
      </div>
    </div>
  </div>
  
  <!-- Modal: Cambiar contraseña de usuario (solo administradores) -->
  <div class="modal-overlay" *ngIf="showChangePasswordModal">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <button type="button" class="btn-close-modal" (click)="cerrarModalCambioContrasena()">
        <i class="pi pi-times"></i>
      </button>

      <h2>{{ 'cambiarContrasena' | translate }}</h2>

      <div class="modal-body">
        <p *ngIf="usuarioCambioContrasena">
          {{ 'cambiarContrasena' | translate }} para el usuario
          <strong>{{ usuarioCambioContrasena.nombre_usuario }}</strong>
        </p>

        <div class="form-group">
          <label>{{ 'contrasenaActual' | translate }}</label>
          <div class="password-input-wrapper">
            <input
              [type]="showCurrentPasswordChange ? 'text' : 'password'"
              [(ngModel)]="passwordChangeForm.currentPassword"
              class="form-input"
              placeholder="{{ 'placeholderContrasenaActual' | translate }}"
            />
            <button
              type="button"
              class="btn-toggle-password"
              (click)="togglePasswordVisibilityCambio('current')"
            >
              <i class="pi" [ngClass]="showCurrentPasswordChange ? 'pi-eye-slash' : 'pi-eye'"></i>
            </button>
          </div>
        </div>

        <div class="form-group">
          <label>{{ 'contrasenaNueva' | translate }}</label>
          <div class="password-input-wrapper">
            <input
              [type]="showNewPasswordChange ? 'text' : 'password'"
              [(ngModel)]="passwordChangeForm.newPassword"
              class="form-input"
              placeholder="{{ 'placeholderContrasenaNueva' | translate }}"
            />
            <button
              type="button"
              class="btn-toggle-password"
              (click)="togglePasswordVisibilityCambio('new')"
            >
              <i class="pi" [ngClass]="showNewPasswordChange ? 'pi-eye-slash' : 'pi-eye'"></i>
            </button>
          </div>
        </div>

        <div class="form-group">
          <label>{{ 'confirmarContrasena' | translate }}</label>
          <div class="password-input-wrapper">
            <input
              [type]="showConfirmPasswordChange ? 'text' : 'password'"
              [(ngModel)]="passwordChangeForm.confirmPassword"
              class="form-input"
              placeholder="{{ 'placeholderContrasenaConfirmar' | translate }}"
            />
            <button
              type="button"
              class="btn-toggle-password"
              (click)="togglePasswordVisibilityCambio('confirm')"
            >
              <i class="pi" [ngClass]="showConfirmPasswordChange ? 'pi-eye-slash' : 'pi-eye'"></i>
            </button>
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn-cancel" (click)="cerrarModalCambioContrasena()" [disabled]="isChangingPassword">
          <i class="pi pi-times"></i>
          {{ 'cancelar' | translate }}
        </button>
        <button
          type="button"
          class="btn-primary"
          (click)="confirmarCambioContrasena()"
          [disabled]="isChangingPassword"
        >
          <i class="pi" [ngClass]="isChangingPassword ? 'pi-spin pi-spinner' : 'pi-check'"></i>
          <span>{{ isChangingPassword ? ('guardandoCambios' | translate) : ('cambiarContrasena' | translate) }}</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de eliminación física removido: en Gestión de Usuarios solo se desactiva el usuario -->
</div>
